"use strict";(()=>{var a={};a.id=408,a.ids=[408],a.modules={5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6037:a=>{a.exports=require("mongoose")},6489:(a,b,c)=>{c.d(b,{A:()=>h});var d=c(6037),e=c.n(d);let f=process.env.MONGODB_URI;if(!f)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let g=global.mongoose;g||(g=global.mongoose={conn:null,promise:null});let h=async function(){if(g.conn)return g.conn;g.promise||(g.promise=e().connect(f,{bufferCommands:!1,maxPoolSize:10,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,family:4}).then(a=>(console.log("✅ Connected to MongoDB"),a)));try{g.conn=await g.promise}catch(a){throw g.promise=null,a}return g.conn}},7872:(a,b,c)=>{c.d(b,{A:()=>h});var d=c(6037),e=c.n(d);let f=new(e()).Schema({id:{type:String,required:!0},rawId:{type:String,required:!0},type:{type:String,required:!0,default:"public-key"},challenge:{type:String,required:!0},userId:{type:String,required:!0},timestamp:{type:Date,required:!0},deviceInfo:{userAgent:String,platform:String,language:String}},{_id:!1}),g=new(e()).Schema({cnicNumber:{type:String,required:!0,unique:!0,match:/^\d{13}$/,index:!0},firstName:{type:String,required:!0,trim:!0,maxlength:50},lastName:{type:String,required:!0,trim:!0,maxlength:50},dateOfBirth:{type:Date,required:!0,validate:{validator:function(a){let b=Math.floor((Date.now()-a)/315576e5);return b>=18&&b<=100},message:"Age must be between 18 and 100 years"}},province:{type:String,required:!0,enum:["Punjab","Sindh","Khyber Pakhtunkhwa","Balochistan","Gilgit"]},constituency:{type:String,required:!0,trim:!0},biometricData:{type:f,required:!0},registrationId:{type:String,unique:!0,default:function(){return"NADRA-"+Date.now().toString(36).toUpperCase()+"-"+Math.random().toString(36).substr(2,6).toUpperCase()}},status:{type:String,enum:["pending","verified","rejected","active"],default:"pending"},submissionTime:{type:Date,default:Date.now},lastUpdated:{type:Date,default:Date.now},ipAddress:String,userAgent:String,isVerified:{type:Boolean,default:!1},verificationDate:Date,verificationNotes:String},{timestamps:!0,toJSON:{transform:function(a,b){return delete b.__v,b}}});g.index({cnicNumber:1}),g.index({registrationId:1}),g.index({submissionTime:-1}),g.index({province:1,constituency:1}),g.index({status:1}),g.pre("save",function(a){this.lastUpdated=new Date,a()}),g.methods.verifyRegistration=function(a){return this.isVerified=!0,this.status="verified",this.verificationDate=new Date,this.verificationNotes=a||"Registration verified successfully",this.save()},g.methods.rejectRegistration=function(a){return this.status="rejected",this.verificationNotes=a||"Registration rejected",this.save()},g.statics.findByCNIC=function(a){return this.findOne({cnicNumber:a})},g.statics.findByRegistrationId=function(a){return this.findOne({registrationId:a})},g.statics.getRegistrationStats=function(){return this.aggregate([{$group:{_id:"$status",count:{$sum:1}}}])};let h=e().models.Registration||e().model("Registration",g)},9515:(a,b,c)=>{c.r(b),c.d(b,{config:()=>p,default:()=>o,handler:()=>r});var d={};c.r(d),c.d(d,{default:()=>l});var e=c(9046),f=c(8667),g=c(3480),h=c(6435),i=c(6489),j=c(7872);let k=new Map;async function l(a,b){if(b.setHeader("Access-Control-Allow-Origin","*"),b.setHeader("Access-Control-Allow-Methods","POST, OPTIONS"),b.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization"),"OPTIONS"===a.method)return void b.status(200).end();if("POST"!==a.method)return b.status(405).json({success:!1,error:"Method not allowed",message:"Only POST requests are accepted"});try{let c=a.headers["x-forwarded-for"]||a.connection.remoteAddress||"unknown";if(!function(a){let b=Date.now();k.has(a)||k.set(a,[]);let c=k.get(a).filter(a=>b-a<9e5);return!(c.length>=5)&&(c.push(b),k.set(a,c),!0)}(c))return b.status(429).json({success:!1,error:"Rate limit exceeded",message:"Too many registration attempts. Please try again in 15 minutes.",retryAfter:900});await (0,i.A)();let{cnicNumber:d,firstName:e,lastName:f,dateOfBirth:g,province:h,constituency:l,biometricData:m}=a.body;if(!d||!e||!f||!g||!h||!l||!m)return b.status(400).json({success:!1,error:"Missing required fields",message:"All fields including biometric data are required"});if(!/^\d{13}$/.test(d))return b.status(400).json({success:!1,error:"Invalid CNIC format",message:"CNIC must be exactly 13 digits"});let n=await j.A.findByCNIC(d);if(n)return b.status(409).json({success:!1,error:"CNIC already registered",message:"This CNIC number is already registered in the system",registrationId:n.registrationId});let o=function(a){if(!a||"object"!=typeof a)return{valid:!1,error:"Biometric data is required"};for(let b of["id","rawId","type","challenge","userId","timestamp"])if(!a[b])return{valid:!1,error:`Missing biometric field: ${b}`};let b=new Date(a.timestamp);return new Date-b>6e5?{valid:!1,error:"Biometric data is too old, please re-register fingerprint"}:{valid:!0}}(m);if(!o.valid)return b.status(400).json({success:!1,error:"Invalid biometric data",message:o.error});let p=new Date(g),q=Math.floor((Date.now()-p)/315576e5);if(q<18||q>100)return b.status(400).json({success:!1,error:"Invalid age",message:"Age must be between 18 and 100 years"});let r={...m,deviceInfo:{userAgent:a.headers["user-agent"]||"Unknown",platform:a.headers["sec-ch-ua-platform"]||"Unknown",language:a.headers["accept-language"]||"Unknown"}},s=new j.A({cnicNumber:d,firstName:e.trim(),lastName:f.trim(),dateOfBirth:new Date(g),province:h,constituency:l,biometricData:r,ipAddress:c,userAgent:a.headers["user-agent"]||"Unknown"}),t=await s.save();console.log(`✅ New NADRA Registration: ${t.registrationId} for CNIC: ${d}`);let u={success:!0,message:"NADRA registration completed successfully",data:{registrationId:t.registrationId,cnicNumber:t.cnicNumber,fullName:`${t.firstName} ${t.lastName}`,province:t.province,constituency:t.constituency,status:t.status,submissionTime:t.submissionTime,biometricRegistered:!0}};b.status(201).json(u)}catch(a){if(console.error("❌ Registration Error:",a),11e3===a.code){let c=Object.keys(a.keyPattern)[0];return b.status(409).json({success:!1,error:"Duplicate entry",message:`This ${c} is already registered in the system`})}if("ValidationError"===a.name){let c=Object.values(a.errors).map(a=>a.message);return b.status(400).json({success:!1,error:"Validation failed",message:"Please check your input data",details:c})}b.status(500).json({success:!1,error:"Internal server error",message:"Registration failed due to server error. Please try again.",timestamp:new Date().toISOString()})}}var m=c(8112),n=c(8766);let o=(0,h.M)(d,"default"),p=(0,h.M)(d,"config"),q=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/registration/register",pathname:"/api/registration/register",bundlePath:"",filename:""},userland:d,distDir:".next",projectDir:""});async function r(a,b,c){let d=await q.prepare(a,b,{srcPage:"/api/registration/register"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h}=d;try{let c=a.method||"GET",d=(0,m.getTracer)(),e=d.getActiveScopeSpan(),i=q.instrumentationOnRequestError.bind(q),j=async e=>q.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:void 0,multiZoneDraftMode:!0,trustHostHeader:void 0,previewProps:h.preview,propagateError:!1,dev:q.isDev,page:"/api/registration/register",projectDir:"",onError:(...b)=>i(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==n.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await j(e):await d.withPropagatedContext(a.headers,()=>d.trace(n.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:m.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},j))}catch(a){if(q.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}}};var b=require("../../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[169],()=>b(b.s=9515));module.exports=c})();